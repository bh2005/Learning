# Lernprojekt: Einführung in Penetrationstests mit Nmap und Wireshark in einer HomeLab-Umgebung

## Einführung

**Penetrationstests** (Pentests) sind gezielte Sicherheitsanalysen, um Schwachstellen in Netzwerken oder Systemen zu identifizieren, bevor Angreifer sie ausnutzen. Dieses Lernprojekt bietet eine Einführung für Einsteiger in die Verwendung von **Nmap** (Network Mapper) und **Wireshark** zur Netzwerkanalyse in einer HomeLab-Umgebung. Es baut auf der HomeLab-Infrastruktur (Proxmox VE, TrueNAS, OPNsense) auf und nutzt die Ubuntu-VM und den OPNsense-Router für praktische Übungen. Das Projekt ist für Lernende mit Grundkenntnissen in Linux und Netzwerkadministration geeignet und ist lokal, kostenlos und datenschutzfreundlich. Es umfasst drei Übungen: Netzwerkscans mit Nmap, Paketanalyse mit Wireshark und Backup der Ergebnisse auf TrueNAS.

**Voraussetzungen**:
- Ubuntu-VM auf Proxmox (IP `192.168.30.101`) mit Checkmk Raw Edition (Site `homelab`) installiert (siehe `syslog_snmp_checkmk_homelab_guide.md`, ).
- OPNsense-Router (IP `192.168.30.1`) mit SSH und Weboberfläche aktiviert.
- HomeLab mit TrueNAS (`192.168.30.100`) für Backups.
- Grundkenntnisse in Linux, Netzwerkprotokolle (TCP/IP) und Sicherheitskonzepte.
- `nmap`, `wireshark`, `tcpdump`, und `rsync` installiert auf der Ubuntu-VM.
- SSH-Schlüsselpaar (z. B. `~/.ssh/id_rsa.pub`, `~/.ssh/id_rsa`).

**Ziele**:
- Durchführung von Netzwerkscans mit Nmap zur Identifizierung von Hosts und offenen Ports.
- Analyse von Netzwerkverkehr mit Wireshark zur Erkennung potenzieller Schwachstellen.
- Speicherung und Backup von Analyseergebnissen auf TrueNAS.

**Hinweis**: Dieses Projekt wird in einer kontrollierten HomeLab-Umgebung durchgeführt. **Penetrationstests dürfen nur mit ausdrücklicher Genehmigung auf Systemen durchgeführt werden, die du besitzt oder für die du autorisiert bist.** Unbefugte Scans sind illegal.

**Quellen**:
- Nmap-Dokumentation: https://nmap.org/book/man.html
- Wireshark-Dokumentation: https://www.wireshark.org/docs
- OPNsense-Dokumentation: https://docs.opnsense.org/manual
- Webquellen:,,,,,

## Lernprojekt: Penetrationstests mit Nmap und Wireshark

### Vorbereitung: Umgebung einrichten
1. **Ubuntu-VM prüfen**:
   - Verbinde dich mit der VM:
     ```bash
     ssh ubuntu@192.168.30.101
     ```
   - Installiere notwendige Pakete:
     ```bash
     sudo apt update
     sudo apt install -y nmap wireshark tcpdump
     ```
   - Konfiguriere Wireshark für Nicht-Root-Zugriff:
     ```bash
     sudo dpkg-reconfigure wireshark-common
     ```
     - Wähle `Yes`, um Nicht-Root-Zugriff zu erlauben.
     - Füge den Benutzer `ubuntu` zur Wireshark-Gruppe hinzu:
       ```bash
       sudo usermod -aG wireshark ubuntu
       ```
   - Prüfe Checkmk:
     ```bash
     curl http://192.168.30.101:5000/homelab
     sudo omd status homelab
     ```
2. **OPNsense prüfen**:
   - Stelle sicher, dass SSH und die Weboberfläche aktiviert sind:
     - Öffne die OPNsense-Weboberfläche: `http://192.168.30.1`.
     - Gehe zu `System > Settings > Administration`.
     - Aktiviere `Enable Secure Shell` und erlaube `root`-Zugriff.
   - Teste SSH:
     ```bash
     ssh root@192.168.30.1
     ```
3. **Projektverzeichnis erstellen**:
   ```bash
   mkdir ~/pentest-homelab
   cd ~/pentest-homelab
   ```

**Tipp**: Arbeite auf der Ubuntu-VM (`192.168.30.101`) mit Zugriff auf OPNsense und TrueNAS. Stelle sicher, dass du die Erlaubnis hast, Scans in deinem eigenen Netzwerk durchzuführen.

### Übung 1: Netzwerkscans mit Nmap

**Ziel**: Nutze Nmap, um Hosts und offene Ports im HomeLab-Netzwerk zu identifizieren.

**Aufgabe**: Führe grundlegende und erweiterte Scans auf OPNsense und Ubuntu-VM durch.

1. **Grundlegender Host-Scan**:
   - Führe einen Host-Scan durch:
     ```bash
     nmap -sn 192.168.30.0/24
     ```
     - **Erklärung**: `-sn` führt einen Ping-Scan durch, um aktive Hosts zu finden.
     - Erwartete Ausgabe:
       ```
       Nmap scan report for 192.168.30.1
       Host is up (0.002s latency).
       Nmap scan report for 192.168.30.100
       Host is up (0.003s latency).
       Nmap scan report for 192.168.30.101
       Host is up (0.001s latency).
       ```

2. **Port-Scan auf OPNsense**:
   - Scanne offene Ports:
     ```bash
     nmap -p- 192.168.30.1
     ```
     - **Erklärung**: `-p-` scannt alle Ports (1-65535).
     - Erwartete Ausgabe (Beispiel):
       ```
       PORT    STATE SERVICE
       22/tcp  open  ssh
       80/tcp  open  http
       443/tcp open  https
       ```

3. **Erweiterter Scan mit Service-Detektion**:
   - Führe einen detaillierten Scan durch:
     ```bash
     nmap -sV -O 192.168.30.1
     ```
     - **Erklärung**: `-sV` erkennt Service-Versionen, `-O` versucht, das Betriebssystem zu identifizieren.
     - Erwartete Ausgabe (Beispiel):
       ```
       PORT    STATE SERVICE VERSION
       22/tcp  open  ssh     OpenSSH 8.9 (FreeBSD)
       80/tcp  open  http    nginx
       443/tcp open  https   nginx
       OS details: FreeBSD 13.0-RELEASE
       ```
   - Speichere die Ergebnisse:
     ```bash
     nmap -sV -O 192.168.30.1 -oX nmap-opnsense.xml
     ```

**Erkenntnis**: Nmap ist ein leistungsstarkes Tool zur Identifizierung von Hosts, offenen Ports und potenziellen Schwachstellen.

**Quelle**: https://nmap.org/book/man.html

### Übung 2: Paketanalyse mit Wireshark

**Ziel**: Nutze Wireshark, um Netzwerkverkehr zu analysieren und potenzielle Sicherheitsprobleme zu erkennen.

**Aufgabe**: Erfasse und analysiere Netzwerkverkehr von OPNsense und Ubuntu-VM.

1. **Netzwerkverkehr mit tcpdump erfassen**:
   - Erfasse Verkehr auf der Schnittstelle `eth0`:
     ```bash
     sudo tcpdump -i eth0 -w capture.pcap
     ```
     - **Erklärung**: Speichert Pakete in `capture.pcap`.
   - Simuliere Verkehr:
     - Öffne einen Browser und rufe `http://192.168.30.1` auf.
     - Simuliere einen fehlgeschlagenen SSH-Login:
       ```bash
       ssh invalid_user@192.168.30.1
       ```
     - Beende die Erfassung mit `Ctrl+C` nach ~1 Minute.

2. **Analyse mit Wireshark**:
   - Starte Wireshark:
     ```bash
     wireshark &
     ```
   - Öffne `capture.pcap` in Wireshark.
   - Analysiere den Verkehr:
     - Filter: `ip.addr == 192.168.30.1` (zeigt Verkehr von/zu OPNsense).
     - Suche nach HTTP-Verkehr:
       - Filter: `http`.
       - Erwartete Ausgabe: HTTP-Anfragen an `192.168.30.1:80`.
     - Suche nach SSH-Fehlern:
       - Filter: `ssh`.
       - Erwartete Ausgabe: SSH-Pakete mit fehlgeschlagenen Authentifizierungen.
   - Speichere die Analyse:
     - Exportiere als PDF: `File > Export Objects > PDF`.

3. **Sicherheitsprobleme identifizieren**:
   - Suche nach unverschlüsseltem Verkehr:
     - Filter: `http.request.method == GET`.
     - Erwartete Ausgabe: Unverschlüsselte HTTP-Anfragen (potenzielle Schwachstelle).
   - Prüfe auf verdächtige Verbindungen:
     - Filter: `ip.src != 192.168.30.0/24`.
     - Erwartete Ausgabe: Falls externe IPs auftauchen, könnte dies ein Problem anzeigen.

**Erkenntnis**: Wireshark ermöglicht die detaillierte Analyse von Netzwerkverkehr, um Schwachstellen wie unverschlüsselten Datenverkehr zu identifizieren.

**Quelle**: https://www.wireshark.org/docs/wsug_html_chunked

### Übung 3: Backup und Analyse der Ergebnisse auf TrueNAS

**Ziel**: Speichere und sichere Pentest-Ergebnisse auf TrueNAS und dokumentiere Erkenntnisse.

**Aufgabe**: Automatisiere das Backup von Nmap- und Wireshark-Daten und analysiere Schwachstellen.

1. **Backup-Skript erstellen**:
   - Erstelle ein Skript:
     ```bash
     nano backup_pentest.sh
     ```
     - Inhalt:
       ```bash
       #!/bin/bash
       DATE=$(date +%F)
       BACKUP_DIR=/home/ubuntu/pentest-homelab/backup-$DATE
       mkdir -p $BACKUP_DIR
       # Copy Nmap and Wireshark results
       cp *.xml *.pcap $BACKUP_DIR/
       # Create a simple report
       echo "Pentest Report - $DATE" > $BACKUP_DIR/report.txt
       echo "Nmap Results:" >> $BACKUP_DIR/report.txt
       nmap -sV -O 192.168.30.1 >> $BACKUP_DIR/report.txt
       echo "Wireshark Findings: Check capture.pcap for HTTP/SSH traffic" >> $BACKUP_DIR/report.txt
       # Transfer to TrueNAS
       rsync -av $BACKUP_DIR root@192.168.30.100:/mnt/tank/backups/pentest-homelab/
       ```
     - Ausführbar machen:
       ```bash
       chmod +x backup_pentest.sh
       ```
   - Teste das Skript:
     ```bash
     ./backup_pentest.sh
     ```
     - Prüfe auf TrueNAS:
       ```bash
       ssh root@192.168.30.100 ls /mnt/tank/backups/pentest-homelab/
       ```
       - Erwartete Ausgabe: `backup-<date>/` mit `nmap-opnsense.xml`, `capture.pcap`, `report.txt`.

2. **Automatisierung mit Cron**:
   - Plane einen Cronjob:
     ```bash
     crontab -e
     ```
     - Füge hinzu:
       ```
       0 5 * * * /home/ubuntu/pentest-homelab/backup_pentest.sh
       ```
     - **Erklärung**: Sichert Ergebnisse täglich um 05:00 Uhr.

3. **Schwachstellenanalyse**:
   - Dokumentiere Erkenntnisse in `report.txt`:
     - Beispiel: „Offene Ports auf OPNsense (22, 80, 443) könnten Angriffsvektoren sein, wenn nicht gesichert.“
     - Beispiel: „Unverschlüsselter HTTP-Verkehr erkannt; empfehle Umstellung auf HTTPS.“
   - Prüfe in Checkmk:
     - Öffne Checkmk: `http://192.168.30.101:5000/homelab`.
     - Gehe zu `Monitor > Event Console`.
     - Suche nach Ereignissen wie `failed login` (aus Übung 2), die mit Wireshark-Daten korrelieren.

**Erkenntnis**: Backups auf TrueNAS sichern Pentest-Daten, während strukturierte Analysen Schwachstellen priorisieren.

**Quelle**: https://docs.opnsense.org/manual, https://www.rsync.org

### Schritt 4: Integration mit HomeLab
1. **Netzwerkmanagement mit OPNsense**:
   - Aktualisiere die Firewall-Regel in OPNsense, um Scans zu erlauben (für Testzwecke):
     - Quelle: `192.168.30.101`
     - Ziel: `192.168.30.0/24`
     - Ports: `Alle`
     - Aktion: `Allow`
     - **Hinweis**: Entferne diese Regel nach dem Test, um das Netzwerk zu sichern.
   - Prüfe Firewall-Logs:
     ```bash
     ssh root@192.168.30.1 "cat /var/log/filter/latest.log"
     ```

2. **Monitoring mit Checkmk**:
   - Füge Nmap-Überwachung hinzu:
     - Erstelle ein Skript für regelmäßige Scans:
       ```bash
       nano nmap_checkmk.sh
       ```
       - Inhalt:
         ```bash
         #!/bin/bash
         nmap -sV -O 192.168.30.1 -oX /home/ubuntu/pentest-homelab/nmap-checkmk.xml
         ```
       - Ausführbar machen:
         ```bash
         chmod +x nmap_checkmk.sh
         ```
     - Integriere in Checkmk:
       - Gehe zu `Setup > Services > Manual checks > Custom checks`.
       - Host: `opnsense`.
       - Check: `Nmap Scan`, Skript: `/home/ubuntu/pentest-homelab/nmap_checkmk.sh`.
       - Speichern und `Discover services`.
     - Prüfe:
       - Gehe zu `Monitor > All services`.
       - Erwartete Ausgabe: Status `OK` für Nmap-Scan.

### Schritt 5: Erweiterung der Übungen
1. **Erweiterte Nmap-Scans**:
   - Führe einen Skript-Scan durch:
     ```bash
     nmap --script vuln 192.168.30.1
     ```
     - **Erklärung**: Nutzt Nmap-Skripte zur Schwachstellensuche (z. B. bekannte Schwächen in SSH/HTTP).

2. **Erweiterte Wireshark-Analyse**:
   - Analysiere verdächtige Protokolle:
     - Filter: `telnet || ftp`.
     - Erwartete Ausgabe: Falls Telnet/FTP erkannt wird, empfehle Abschaltung wegen Unsicherheit.
   - Erstelle einen Alert in Wireshark:
     - Gehe zu `View > Coloring Rules`.
     - Regel: `http.request.method && !tls` (markiert unverschlüsselten HTTP-Verkehr).

## Best Practices für Schüler

- **Pentest-Design**:
  - Beginne mit einfachen Scans, bevor du komplexe Angriffsvektoren testest.
  - Dokumentiere alle Ergebnisse systematisch.
- **Sicherheit**:
  - Schränke Scan-Zugriff ein:
    ```bash
    sudo ufw allow from 192.168.30.101 to 192.168.30.0/24
    ```
  - Sichere SSH-Schlüssel:
    ```bash
    chmod 600 ~/.ssh/id_rsa
    ```
- **Backup-Strategie**:
  - Nutze die 3-2-1-Regel: 3 Kopien (lokal, TrueNAS, USB), 2 Medien, 1 Off-Site (TrueNAS).
- **Fehlerbehebung**:
  - Prüfe Nmap-Fehler:
    ```bash
    cat nmap-opnsense.xml
    ```
  - Prüfe Wireshark-Captures:
    ```bash
    ls -l *.pcap
    ```

**Quelle**: https://nmap.org, https://www.wireshark.org/docs

## Empfehlungen für Schüler

- **Setup**: Nmap, Wireshark, TrueNAS-Backups.
- **Workloads**: Netzwerkscans und Paketanalyse.
- **Integration**: Proxmox (VM), TrueNAS (Backups), OPNsense (Netzwerk).
- **Beispiel**: Identifizierung offener Ports und unverschlüsselten Verkehrs.

## Tipps für den Erfolg

- **Einfachheit**: Starte mit grundlegenden Scans und Filtern, bevor du erweiterte Techniken anwendest.
- **Übung**: Experimentiere mit Nmap-Skripten (z. B. `vuln`) oder Wireshark-Filtern.
- **Fehlerbehebung**: Nutze Checkmk Event Console und Wireshark-Protokolle.
- **Lernressourcen**: https://nmap.org, https://www.wireshark.org/docs, https://docs.opnsense.org.
- **Dokumentation**: Speichere diese Anleitung auf TrueNAS (`/mnt/tank/docs`).

## Fazit

Dieses Lernprojekt bietet:
- **Praxisorientiert**: Einführung in Penetrationstests mit Nmap und Wireshark.
- **Skalierbarkeit**: Netzwerkanalyse und Schwachstellenerkennung.
- **Lernwert**: Verständnis von Netzwerkscans und Paketanalyse.

**Nächste Schritte**: Möchtest du eine Anleitung zu erweiterten Penetrationstests mit Metasploit, Integration mit Wazuh für Bedrohungserkennung, oder Log-Aggregation mit Fluentd?

**Quellen**:
- Nmap-Dokumentation: https://nmap.org/book/man.html
- Wireshark-Dokumentation: https://www.wireshark.org/docs
- OPNsense-Dokumentation: https://docs.opnsense.org/manual
- Webquellen:,,,,,
```